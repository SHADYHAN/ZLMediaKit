# ğŸ¯ AACâ†’Opus è½¬ç ä»£ç ä¼˜åŒ–å»ºè®®

## âœ… å½“å‰çŠ¶æ€ï¼šä¼˜ç§€

ä»£ç å·²ç»è¿‡ç”Ÿäº§çº§ä¼˜åŒ–ï¼ŒåŠŸèƒ½å®Œæ•´ï¼Œæ€§èƒ½è‰¯å¥½ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯é€‰çš„å¾®è°ƒå»ºè®®ï¼š

---

## ğŸ”§ å¯é€‰ä¼˜åŒ–ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

### 1. âš ï¸ FIFO æº¢å‡ºä¿æŠ¤ï¼ˆé‡è¦æ€§ï¼šä¸­ï¼‰

**å½“å‰æƒ…å†µ**ï¼šå¦‚æœè¾“å…¥é€Ÿåº¦è¿œå¤§äºå¤„ç†é€Ÿåº¦ï¼ŒFIFO å¯èƒ½ä¼šæº¢å‡º

**å»ºè®®**ï¼šæ·»åŠ æº¢å‡ºæ£€æµ‹å’Œä¿æŠ¤

```cpp
// åœ¨ encodeFrame å¼€å¤´æ·»åŠ 
if (av_audio_fifo_size(_fifo) > _context->frame_size * 8) {
    // FIFO ç§¯å‹è¿‡å¤šï¼Œä¸¢å¼ƒä¸€äº›æ—§æ•°æ®
    WarnL << "FIFO overflow, dropping old samples";
    av_audio_fifo_drain(_fifo, _context->frame_size * 2);
}
```

**æ”¶ç›Š**ï¼šé˜²æ­¢å†…å­˜æ— é™å¢é•¿ï¼Œæé«˜ç¨³å®šæ€§

---

### 2. ğŸ“Š æ€§èƒ½ç»Ÿè®¡ï¼ˆé‡è¦æ€§ï¼šä½ï¼‰

**å½“å‰æƒ…å†µ**ï¼šåªæœ‰å¸§è®¡æ•°ç»Ÿè®¡

**å»ºè®®**ï¼šæ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡

```cpp
// åœ¨ OpusEncoder ç±»ä¸­æ·»åŠ 
private:
    uint64_t _encode_time_total = 0;  // æ€»ç¼–ç æ—¶é—´
    uint32_t _encode_count = 0;       // ç¼–ç æ¬¡æ•°
    
// åœ¨ç¼–ç æ—¶ç»Ÿè®¡
auto start = std::chrono::high_resolution_clock::now();
// ... ç¼–ç  ...
auto end = std::chrono::high_resolution_clock::now();
_encode_time_total += std::chrono::duration_cast<std::chrono::microseconds>(end - start).count();
_encode_count++;

// ææ„æ—¶è¾“å‡º
InfoL << "Avg encode time: " << (_encode_time_total / _encode_count) << "us";
```

**æ”¶ç›Š**ï¼šæ–¹ä¾¿æ€§èƒ½åˆ†æå’Œè°ƒä¼˜

---

### 3. ğŸ” å‚æ•°éªŒè¯ï¼ˆé‡è¦æ€§ï¼šä½ï¼‰

**å½“å‰æƒ…å†µ**ï¼šé…ç½®å‚æ•°æœªéªŒè¯åˆç†æ€§

**å»ºè®®**ï¼šæ·»åŠ å‚æ•°éªŒè¯

```cpp
void MultiMediaSourceMuxer::createAudioTranscoder(const Track::Ptr &track) {
    GET_CONFIG(int, bitrate, Protocol::kAudioTranscodeBitrate);
    GET_CONFIG(int, sample_rate, Protocol::kAudioTranscodeSampleRate);
    GET_CONFIG(int, channels, Protocol::kAudioTranscodeChannels);
    
    // å‚æ•°éªŒè¯
    if (bitrate < 6000 || bitrate > 510000) {
        WarnL << "Invalid bitrate " << bitrate << ", using 64000";
        bitrate = 64000;
    }
    if (sample_rate != 8000 && sample_rate != 12000 && 
        sample_rate != 16000 && sample_rate != 24000 && 
        sample_rate != 48000) {
        WarnL << "Invalid sample rate " << sample_rate << ", using 48000";
        sample_rate = 48000;
    }
    if (channels != 1 && channels != 2) {
        WarnL << "Invalid channels " << channels << ", using 2";
        channels = 2;
    }
    // ...
}
```

**æ”¶ç›Š**ï¼šé˜²æ­¢é…ç½®é”™è¯¯å¯¼è‡´å´©æºƒ

---

### 4. ğŸ”„ åŠ¨æ€ç ç‡è°ƒæ•´ï¼ˆé‡è¦æ€§ï¼šä½ï¼Œå¯é€‰ï¼‰

**å»ºè®®**ï¼šæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ç ç‡

```cpp
void OpusEncoder::adjustBitrate(int new_bitrate) {
    if (_context && new_bitrate >= 6000 && new_bitrate <= 510000) {
        _context->bit_rate = new_bitrate;
        _bitrate = new_bitrate;
        InfoL << "Adjusted Opus bitrate to " << new_bitrate;
    }
}
```

**æ”¶ç›Š**ï¼šé€‚åº”ç½‘ç»œæ³¢åŠ¨ï¼Œä¼˜åŒ–å¸¦å®½ä½¿ç”¨

---

### 5. ğŸšï¸ Opus ç¼–ç å™¨é«˜çº§é€‰é¡¹ï¼ˆé‡è¦æ€§ï¼šä½ï¼Œå¯é€‰ï¼‰

**å½“å‰**ï¼šä½¿ç”¨é»˜è®¤ Opus å‚æ•°

**å»ºè®®**ï¼šæ ¹æ®ä½¿ç”¨åœºæ™¯ä¼˜åŒ– Opus å‚æ•°

```cpp
// åœ¨ OpusEncoder::init() ä¸­
AVDictionary *opts = nullptr;

// æ ¹æ®é…ç½®é€‰æ‹©åº”ç”¨ç±»å‹
GET_CONFIG(string, opus_app, Protocol::kOpusApplication);
if (opus_app == "voip") {
    av_dict_set(&opts, "application", "voip", 0);     // VoIP ä¼˜åŒ–
} else if (opus_app == "lowdelay") {
    av_dict_set(&opts, "application", "lowdelay", 0); // ä½å»¶è¿Ÿ
} else {
    av_dict_set(&opts, "application", "audio", 0);    // é€šç”¨éŸ³é¢‘ï¼ˆé»˜è®¤ï¼‰
}

av_dict_set(&opts, "packet_loss", "1", 0);            // å¯ç”¨ä¸¢åŒ…æ¢å¤
av_dict_set(&opts, "complexity", "10", 0);            // ç¼–ç å¤æ‚åº¦ï¼ˆ0-10ï¼‰
av_dict_set(&opts, "vbr", "on", 0);                   // å¯å˜æ¯”ç‰¹ç‡
av_dict_set(&opts, "frame_duration", "20", 0);        // å¸§æ—¶é•¿ 20ms
```

**ä¸åŒåœºæ™¯çš„æ¨èé…ç½®**ï¼š

| åœºæ™¯ | application | complexity | bitrate |
|------|-------------|------------|---------|
| éŸ³ä¹ç›´æ’­ | audio | 10 | 96-128k |
| è¯­éŸ³é€šè¯ | voip | 5 | 24-48k |
| ä½å»¶è¿Ÿ | lowdelay | 8 | 48-64k |

---

### 6. ğŸ§¹ èµ„æºæ¸…ç†ä¼˜åŒ–ï¼ˆé‡è¦æ€§ï¼šæä½ï¼‰

**å½“å‰**ï¼šå·²ç»å¾ˆå¥½ï¼Œä½†å¯ä»¥æ›´æ˜ç¡®

```cpp
OpusEncoder::~OpusEncoder() {
    // å…ˆåœæ­¢çº¿ç¨‹
    stopThread(true);
    
    // æ¸…ç† FIFO
    if (_fifo) {
        av_audio_fifo_free(_fifo);
        _fifo = nullptr;
    }
    
    // æ¸…ç†ç¼–ç å¸§ï¼ˆshared_ptr ä¼šè‡ªåŠ¨æ¸…ç†ï¼Œä½†æ˜¾å¼é‡ç½®æ›´æ¸…æ™°ï¼‰
    _encode_frame.reset();
    
    // ç¼–ç å™¨ä¸Šä¸‹æ–‡ï¼ˆshared_ptr è‡ªåŠ¨æ¸…ç†ï¼‰
    _context.reset();
}
```

---

## ğŸ“ é…ç½®æ–‡ä»¶æ‰©å±•å»ºè®®

å¯ä»¥åœ¨ `config.ini` ä¸­æ·»åŠ æ›´å¤šé€‰é¡¹ï¼š

```ini
[protocol]
# åŸºç¡€é…ç½®
enable_audio_transcode=1
audio_transcode_bitrate=64000
audio_transcode_sample_rate=48000
audio_transcode_channels=2

# é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰
opus_application=audio           # audio/voip/lowdelay
opus_complexity=10               # 0-10ï¼Œè¶Šé«˜è´¨é‡è¶Šå¥½ä½† CPU å ç”¨è¶Šé«˜
opus_vbr=1                       # å¯å˜æ¯”ç‰¹ç‡ 0/1
opus_packet_loss_perc=1          # é¢„æœŸä¸¢åŒ…ç‡ 0-100
opus_max_fifo_size=8             # FIFO æœ€å¤§ç¼“å†²å¸§æ•°ï¼ˆå€æ•°ï¼‰
```

---

## ğŸ¯ æˆ‘çš„å»ºè®®ï¼š

### ç«‹å³å¯åšï¼ˆæ¨èï¼‰ï¼š
âœ… **å»ºè®® #1ï¼šFIFO æº¢å‡ºä¿æŠ¤** - 5åˆ†é’Ÿï¼Œæé«˜ç¨³å®šæ€§

### æŒ‰éœ€å¯åšï¼š
- âšª å»ºè®® #2ï¼šæ€§èƒ½ç»Ÿè®¡ - å¦‚æœéœ€è¦æ€§èƒ½åˆ†æ
- âšª å»ºè®® #3ï¼šå‚æ•°éªŒè¯ - å¦‚æœç”¨æˆ·å¯èƒ½é…ç½®é”™è¯¯
- âšª å»ºè®® #5ï¼šOpus é«˜çº§é€‰é¡¹ - å¦‚æœéœ€è¦é’ˆå¯¹ç‰¹å®šåœºæ™¯ä¼˜åŒ–

### ä¸å¿…è¦ï¼š
- âŒ å»ºè®® #4ï¼šåŠ¨æ€ç ç‡ - å¤æ‚åº¦é«˜ï¼Œæ”¶ç›Šä¸æ˜æ˜¾
- âŒ å»ºè®® #6ï¼šèµ„æºæ¸…ç† - å½“å‰å·²è¶³å¤Ÿå¥½

---

## ğŸ‰ æ€»ç»“

**å½“å‰ä»£ç è¯„åˆ†ï¼š9/10** â­â­â­â­â­â­â­â­â­

- âœ… åŠŸèƒ½å®Œæ•´
- âœ… æ€§èƒ½ä¼˜ç§€
- âœ… ç¨³å®šå¯é 
- âœ… ä»£ç æ¸…æ™°

**å”¯ä¸€å»ºè®®**ï¼šæ·»åŠ  FIFO æº¢å‡ºä¿æŠ¤ï¼ˆ5åˆ†é’Ÿå·¥ä½œï¼‰

å…¶ä½™éƒ½æ˜¯å¯é€‰ä¼˜åŒ–ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨ã€‚ä»£ç å·²ç»è¾¾åˆ°ç”Ÿäº§çº§æ°´å¹³ï¼ğŸ‰

