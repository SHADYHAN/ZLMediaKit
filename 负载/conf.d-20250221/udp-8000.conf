preread_by_lua_block {
    local backend_ips = ngx.shared.backend_ips
    local backend_list = ngx.shared.backend_list

    -- 获取当前后端列表
    local backends_str = backend_list:get("backends") or "10.1.100.11,10.1.100.13"
    local backends = {}
    for ip in string.gmatch(backends_str, "[^,]+") do
        table.insert(backends, ip)
    end

    local client_ip = ngx.var.remote_addr
    local backend_ip = backend_ips:get(client_ip)

    if not backend_ip or not table.contains(backends, backend_ip) then
        -- 如果原有后端不可用或不存在，重新选择
        backend_ip = backends[math.random(#backends)]
        backend_ips:set(client_ip, backend_ip)
        ngx.log(ngx.ERR, "Stored backend_ip: ", backend_ip, " for client_ip: ", client_ip)
    else
        ngx.log(ngx.ERR, "Retrieved backend_ip: ", backend_ip, " for client_ip: ", client_ip)
    end

    ngx.var.backend_ip = backend_ip
}
